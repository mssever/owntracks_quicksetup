#!/bin/sh

# enroll or update an ACME certificate using LEGO

# if we don't yet have a certificate, enroll, else renew.
# stop the Web server, as LEGO will launch its own.

lego=/usr/bin/lego

systemctl is-active apache2.service > /dev/null &&
	systemctl stop apache2.service

# change into this directory in which LEGO will create its home (.lego/)
cd "{{ otdir }}/tls" || { echo "Cannot chdir to {{ otdir }}/tls"; exit 2; }

if ! [ -f "{{ otdir }}/tls/cert.crt" ]; then

	# enroll
	$lego \
		--accept-tos \
		--email="{{ email }}" \
		--domains="{{ dns_domain }}" \
		--http \
		run \
		--run-hook="{{ otdir }}/lego/installcerts.sh"
else

	# renew: https://go-acme.github.io/lego/usage/cli/renew-a-certificate/
	$lego \
		--email="{{ email }}" \
		--domains="{{ dns_domain }}" \
		--http \
		renew \
		--renew-hook="{{ otdir }}/lego/installcerts.sh"

	systemctl restart apache2.service
fi

